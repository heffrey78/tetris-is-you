<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioSystem Tempo Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            margin: 5px;
            padding: 10px 15px;
            font-size: 16px;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 5px;
        }
        .log {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>AudioSystem Tempo Integration Test</h1>
    <p>This test verifies the integration between AudioSystem and DifficultyScaler speed events.</p>
    
    <div class="controls">
        <button onclick="initializeAudio()">Initialize Audio System</button>
        <button onclick="testSpeedChange(1.5)">Test Speed 1.5x</button>
        <button onclick="testSpeedChange(2.0)">Test Speed 2.0x</button>
        <button onclick="testSpeedChange(3.0)">Test Speed 3.0x</button>
        <button onclick="testSpeedChange(5.0)">Test Speed 5.0x</button>
        <button onclick="testSpeedChange(1.0)">Reset to 1.0x</button>
        <button onclick="playTestSound()">Play Test Sound</button>
        <button onclick="getTempoInfo()">Get Tempo Info</button>
    </div>
    
    <div class="status" id="status">
        Status: Not initialized
    </div>
    
    <div class="log" id="log">
        Test log will appear here...
    </div>

    <script type="module">
        import { AudioSystem } from './dist/AudioSystem.js';
        
        let audioSystem = null;
        
        // Expose functions to global scope for button clicks
        window.initializeAudio = async function() {
            try {
                audioSystem = new AudioSystem({
                    masterVolume: 0.7,
                    musicVolume: 0.5,
                    sfxVolume: 0.8,
                    enableMusic: false, // Disable music for testing
                    enableSFX: true,
                    enableTempoScaling: true,
                    tempoScaling: {
                        minBPM: 60,
                        maxBPM: 180,
                        transitionDuration: 2.0,
                        scalingCurve: 'linear',
                        responsiveness: 0.8
                    }
                });
                
                // Resume audio context (required for user interaction)
                await audioSystem.resumeContext();
                
                updateStatus('Audio system initialized successfully');
                log('AudioSystem created with tempo scaling enabled');
            } catch (error) {
                updateStatus('Failed to initialize audio system: ' + error.message);
                log('ERROR: ' + error.message);
            }
        };
        
        window.testSpeedChange = function(speedMultiplier) {
            if (!audioSystem) {
                updateStatus('Please initialize audio system first');
                return;
            }
            
            try {
                // Create a mock speed change event
                const eventDetail = {
                    oldSpeed: 1.0,
                    newSpeed: speedMultiplier,
                    dropInterval: Math.floor(1000 / speedMultiplier),
                    speedChange: speedMultiplier - 1.0,
                    level: Math.floor(speedMultiplier * 3),
                    difficultyName: getSpeedName(speedMultiplier)
                };
                
                const event = new CustomEvent('speedChange', {
                    detail: eventDetail
                });
                
                // Dispatch the event
                window.dispatchEvent(event);
                
                updateStatus(`Speed change event dispatched: ${speedMultiplier}x`);
                log(`Dispatched speedChange event: ${JSON.stringify(eventDetail, null, 2)}`);
            } catch (error) {
                updateStatus('Failed to dispatch speed change event: ' + error.message);
                log('ERROR: ' + error.message);
            }
        };
        
        window.playTestSound = function() {
            if (!audioSystem) {
                updateStatus('Please initialize audio system first');
                return;
            }
            
            try {
                audioSystem.playSoundEffect('pieceRotate');
                log('Played test sound effect: pieceRotate');
            } catch (error) {
                updateStatus('Failed to play sound: ' + error.message);
                log('ERROR: ' + error.message);
            }
        };
        
        window.getTempoInfo = function() {
            if (!audioSystem) {
                updateStatus('Please initialize audio system first');
                return;
            }
            
            try {
                const tempoInfo = audioSystem.getTempoInfo();
                if (tempoInfo) {
                    updateStatus(`Tempo: ${tempoInfo.bpm.toFixed(1)} BPM, Speed: ${tempoInfo.speedMultiplier.toFixed(2)}x, Transitioning: ${tempoInfo.isTransitioning}`);
                    log(`Current tempo info: ${JSON.stringify(tempoInfo, null, 2)}`);
                } else {
                    updateStatus('Tempo controller not available');
                    log('TempoController not available (tempo scaling disabled?)');
                }
            } catch (error) {
                updateStatus('Failed to get tempo info: ' + error.message);
                log('ERROR: ' + error.message);
            }
        };
        
        function getSpeedName(speed) {
            if (speed < 1.5) return 'Beginner';
            if (speed < 2.5) return 'Intermediate';
            if (speed < 4.0) return 'Advanced';
            return 'Expert';
        }
        
        function updateStatus(message) {
            document.getElementById('status').textContent = 'Status: ' + message;
        }
        
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        // Listen for tempo change events
        window.addEventListener('tempoChange', (event) => {
            const detail = event.detail;
            log(`TEMPO CHANGE EVENT: ${detail.oldBPM.toFixed(1)} â†’ ${detail.newBPM.toFixed(1)} BPM (${detail.speedMultiplier.toFixed(2)}x, ${detail.curve} curve)`);
        });
        
        // Initialize the log
        log('Test page loaded. Click "Initialize Audio System" to begin.');
    </script>
</body>
</html>